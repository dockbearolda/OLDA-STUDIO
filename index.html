<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Studio Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        :root { --apple-blue: #007AFF; --apple-bg: #F5F5F7; }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; background-color: var(--apple-bg); color: #1d1d1f; -webkit-font-smoothing: antialiased; overflow-x: hidden; }
        
        .ios-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); border-radius: 24px; border: 1px solid rgba(0,0,0,0.05); }
        .ios-input { background: #E3E3E8; border: none; border-radius: 12px; padding: 12px 16px; font-size: 16px; width: 100%; outline: none; transition: all 0.2s; }
        .ios-input:focus { background: #D1D1D6; }
        
        /* Select avec pastille custom */
        .custom-select-wrapper { position: relative; }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; border: 1px solid rgba(0,0,0,0.1); }

        /* Button Apple */
        .ios-btn { background: var(--apple-blue); color: white; border-radius: 14px; padding: 18px; font-size: 17px; font-weight: 600; text-align: center; width: 100%; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .ios-btn:active { transform: scale(0.96); opacity: 0.8; }
        
        /* Toggle Paiement Apple */
        .pay-toggle { display: flex; background: #E3E3E8; border-radius: 12px; p: 4px; padding: 4px; position: relative; cursor: pointer; }
        .pay-option { flex: 1; text-align: center; padding: 10px; font-size: 14px; font-weight: 600; z-index: 1; transition: color 0.3s; }
        .pay-slider { position: absolute; width: calc(50% - 4px); height: calc(100% - 8px); background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .paid .pay-slider { transform: translateX(100%); }
        .paid .opt-paid { color: #34C759; }

        .step-container { display: none; animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .step-container.active { display: flex; flex-direction: column; gap: 20px; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body class="min-h-screen p-5">

    <div class="max-w-md mx-auto w-full pt-6">
        <header class="mb-8">
            <p id="step-label" class="text-xs font-bold text-blue-500 uppercase tracking-widest mb-1">√âTAPE 1 SUR 4</p>
            <h1 id="step-title" class="text-3xl font-extrabold tracking-tight">Client</h1>
        </header>

        <div id="step-1" class="step-container active">
            <div class="ios-card p-6 space-y-5">
                <div>
                    <label class="text-[11px] font-bold text-gray-400 uppercase ml-1">N¬∞ Commande</label>
                    <input type="text" id="orderNo" class="ios-input mt-1" readonly>
                </div>
                <div>
                    <label class="text-[11px] font-bold text-gray-400 uppercase ml-1">Nom</label>
                    <input type="text" id="clientName" class="ios-input mt-1" placeholder="Jean Dupont">
                </div>
                <div>
                    <label class="text-[11px] font-bold text-gray-400 uppercase ml-1">T√©l√©phone</label>
                    <input type="tel" id="clientPhone" class="ios-input mt-1" placeholder="06 00 00 00 00">
                </div>
            </div>
            <button onclick="nav(2)" class="ios-btn mt-4">Suivant</button>
        </div>

        <div id="step-2" class="step-container">
            <div class="ios-card p-6 space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[11px] font-bold text-gray-400 uppercase">Collection</label>
                        <select id="collection" class="ios-input mt-1" onchange="updateRefs()">
                            <option value="Homme">Homme</option>
                            <option value="Femme">Femme</option>
                            <option value="Enfant">Enfant</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-gray-400 uppercase">R√©f√©rence</label>
                        <select id="refSelect" class="ios-input mt-1"></select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[11px] font-bold text-gray-400 uppercase">Taille</label>
                        <select id="size" class="ios-input mt-1">
                            <option>S</option><option>M</option><option>L</option><option>XL</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-gray-400 uppercase">Couleur T-shirt</label>
                        <select id="tshirtColor" class="ios-input mt-1" onchange="updateMockup()"></select>
                    </div>
                </div>
                <div>
                    <label class="text-[11px] font-bold text-gray-400 uppercase">Couleur Logo</label>
                    <select id="logoColor" class="ios-input mt-1"></select>
                </div>
            </div>
            <div class="flex gap-3 mt-4">
                <button onclick="nav(1)" class="ios-btn bg-gray-200 !text-gray-600">Retour</button>
                <button onclick="nav(3)" class="ios-btn">Design</button>
            </div>
        </div>

        <div id="step-3" class="step-container">
            <div class="flex bg-gray-200 p-1 rounded-2xl mb-4">
                <button id="btn-av" onclick="setSide('front')" class="flex-1 py-2 text-sm font-bold rounded-xl active bg-white shadow-sm text-blue-600">AVANT</button>
                <button id="btn-ar" onclick="setSide('back')" class="flex-1 py-2 text-sm font-bold rounded-xl text-gray-500">ARRI√àRE</button>
            </div>
            
            <div class="bg-white rounded-[32px] p-4 shadow-inner mb-4 flex justify-center overflow-hidden border border-gray-100">
                <canvas id="c" width="300" height="350"></canvas>
            </div>

            <div class="ios-card p-5 space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <select id="logoSelect" class="ios-input text-sm" onchange="applyLogo(this.value)">
                        <option value="">Logo Catalogue</option>
                        <option>AVI-01</option><option>SXM-12</option>
                    </select>
                    <label class="ios-input text-sm text-center cursor-pointer flex items-center justify-center bg-blue-50 text-blue-600 font-bold">
                        Photo Perso
                        <input type="file" class="hidden" accept="image/*" onchange="uploadLogo(event)">
                    </label>
                </div>
                <textarea id="note" class="ios-input h-14" placeholder="Note particuli√®re..."></textarea>
            </div>

            <div class="flex gap-3">
                <button onclick="nav(2)" class="ios-btn bg-gray-200 !text-gray-600">Retour</button>
                <button onclick="nav(4)" class="ios-btn">Paiement</button>
            </div>
        </div>

        <div id="step-4" class="step-container">
            <div class="ios-card p-6 space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[11px] font-bold text-gray-400 uppercase ml-1 text-center block">Prix T-shirt</label>
                        <input type="number" id="price" class="ios-input mt-1 text-center text-xl font-bold" value="25" oninput="calcTotal()">
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-gray-400 uppercase ml-1 text-center block">Perso</label>
                        <input type="number" id="customPrice" class="ios-input mt-1 text-center text-xl font-bold" value="0" oninput="calcTotal()">
                    </div>
                </div>

                <div class="text-center py-4 border-y border-gray-100">
                    <p class="text-[11px] font-bold text-gray-400 uppercase">Total √† encaisser</p>
                    <h2 id="totalLabel" class="text-5xl font-black tracking-tighter mt-1">25 ‚Ç¨</h2>
                </div>

                <div id="payToggle" class="pay-toggle" onclick="togglePaid()">
                    <div class="pay-slider"></div>
                    <div class="pay-option opt-unpaid">NON PAY√â</div>
                    <div class="pay-option opt-paid">PAY√â ‚úÖ</div>
                </div>
            </div>
            <button onclick="submit()" id="submitBtn" class="ios-btn bg-black text-white mt-4 shadow-2xl">Finaliser la Commande</button>
        </div>
    </div>

    <script>
        const COLORS = [
            {n: 'Blanc', h: '#FFFFFF'}, {n: 'Noir', h: '#1c1c1e'}, {n: 'Gris', h: '#8E8E93'},
            {n: 'Rouge', h: '#FF3B30'}, {n: 'Bleu', h: '#007AFF'}, {n: 'Vert', h: '#34C759'},
            {n: 'Jaune', h: '#FFCC00'}, {n: 'Orange', h: '#FF9500'}, {n: 'Rose', h: '#FF2D55'}, {n: 'Violet', h: '#AF52DE'}
        ];

        let canvas, side = 'front', isPaid = false;
        let designs = { front: null, back: null };

        window.onload = () => {
            canvas = new fabric.Canvas('c');
            initUI();
            updateRefs();
            updateMockup();
        };

        function initUI() {
            // G√©n√©rer N¬∞ Commande
            const now = new Date();
            document.getElementById('orderNo').value = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}-${now.getHours()}${now.getMinutes()}`;
            
            // Remplir les selects couleur
            const ts = document.getElementById('tshirtColor');
            const lg = document.getElementById('logoColor');
            COLORS.forEach(c => {
                ts.add(new Option('‚óè ' + c.n, c.n));
                lg.add(new Option('‚óè ' + c.n, c.n));
            });
            ts.selectedIndex = 0; lg.selectedIndex = 1;
        }

        function updateRefs() {
            const coll = document.getElementById('collection').value;
            const ref = document.getElementById('refSelect');
            const prefix = coll === 'Homme' ? 'H' : coll === 'Femme' ? 'F' : 'E';
            ref.innerHTML = '';
            for(let i=1; i<=10; i++) {
                const val = prefix + i.toString().padStart(3,'0');
                ref.add(new Option(val, val));
            }
        }

        function updateMockup() {
            canvas.clear();
            const colorName = document.getElementById('tshirtColor').value;
            const hex = COLORS.find(c => c.n === colorName).h;
            
            const path = side === 'front' ? 
                "M 93,23 L 65,33 L 14,65 L 33,108 L 51,94 L 51,300 L 229,300 L 229,94 L 247,108 L 266,65 L 215,33 L 187,23 C 178,42 150,52 140,52 C 130,52 102,42 93,23 Z" :
                "M 93,23 L 65,33 L 14,65 L 33,108 L 51,94 L 51,300 L 229,300 L 229,94 L 247,108 L 266,65 L 215,33 L 187,23 C 182,28 165,33 140,33 C 115,33 98,28 93,23 Z";
            
            const tshirt = new fabric.Path(path, {
                left: 150, top: 175, fill: hex, stroke: '#ddd', strokeWidth: 1, originX: 'center', originY: 'center', selectable: false
            });
            canvas.add(tshirt);
            if(designs[side]) canvas.add(designs[side]);
            canvas.renderAll();
        }

        function setSide(s) {
            side = s;
            document.getElementById('btn-av').className = s === 'front' ? 'flex-1 py-2 text-sm font-bold rounded-xl bg-white shadow-sm text-blue-600' : 'flex-1 py-2 text-sm font-bold rounded-xl text-gray-500';
            document.getElementById('btn-ar').className = s === 'back' ? 'flex-1 py-2 text-sm font-bold rounded-xl bg-white shadow-sm text-blue-600' : 'flex-1 py-2 text-sm font-bold rounded-xl text-gray-500';
            updateMockup();
        }

        function applyLogo(val) {
            if(!val) return;
            const colorHex = COLORS.find(c => c.n === document.getElementById('logoColor').value).h;
            const txt = new fabric.Text(val, { left: 150, top: 130, fontSize: 24, fill: colorHex, originX: 'center', fontWeight: 'bold' });
            if(designs[side]) canvas.remove(designs[side]);
            designs[side] = txt;
            canvas.add(txt); canvas.setActiveObject(txt);
        }

        function uploadLogo(e) {
            const reader = new FileReader();
            reader.onload = (event) => {
                fabric.Image.fromURL(event.target.result, (img) => {
                    img.scaleToWidth(100);
                    img.set({ left: 150, top: 150, originX: 'center' });
                    if(designs[side]) canvas.remove(designs[side]);
                    designs[side] = img;
                    canvas.add(img); canvas.setActiveObject(img);
                });
            };
            reader.readAsDataURL(e.target.files[0]);
        }

        function togglePaid() {
            isPaid = !isPaid;
            document.getElementById('payToggle').classList.toggle('paid', isPaid);
        }

        function calcTotal() {
            const total = (parseFloat(document.getElementById('price').value)||0) + (parseFloat(document.getElementById('customPrice').value)||0);
            document.getElementById('totalLabel').innerText = total + " ‚Ç¨";
        }

        function nav(s) {
            document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
            document.getElementById('step-'+s).classList.add('active');
            document.getElementById('step-label').innerText = `√âTAPE ${s} SUR 4`;
            const titles = ["Client", "Collection", "Design", "Paiement"];
            document.getElementById('step-title').innerText = titles[s-1];
            window.scrollTo(0,0);
        }

        function submit() {
            const btn = document.getElementById('submitBtn');
            btn.innerText = "‚è≥ Envoi..."; btn.disabled = true;
            
            const payload = {
                orderNo: document.getElementById('orderNo').value,
                client: document.getElementById('clientName').value,
                phone: document.getElementById('clientPhone').value,
                collection: document.getElementById('collection').value + " (" + document.getElementById('refSelect').value + ")",
                size: document.getElementById('size').value,
                tshirtColor: document.getElementById('tshirtColor').value,
                logoColor: document.getElementById('logoColor').value,
                logoFront: designs.front instanceof fabric.Text ? designs.front.text : "Image Import√©e",
                logoBack: designs.back instanceof fabric.Text ? designs.back.text : "Image Import√©e",
                note: document.getElementById('note').value,
                price: document.getElementById('price').value,
                customPrice: document.getElementById('customPrice').value,
                total: document.getElementById('totalLabel').innerText,
                paid: isPaid ? "OUI" : "NON",
                image: canvas.toDataURL()
            };

            // Utilise l'URL de ton script actuel
            fetch("TON_URL_SCRIPT_GOOGLE", { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
            .then(() => { alert("üöÄ Commande valid√©e !"); location.reload(); })
            .catch(() => { alert("Erreur de r√©seau"); btn.disabled = false; btn.innerText = "R√©essayer"; });
        }
    </script>
</body>
</html>
