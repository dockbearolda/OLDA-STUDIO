<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Studio Ultra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        :root { --apple-blue: #007AFF; }
        body { font-family: -apple-system, sans-serif; background: #F2F2F7; color: #1c1c1e; -webkit-font-smoothing: antialiased; }
        
        /* Elements Apple Design */
        .ios-card { background: white; border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 15px; }
        .ios-input { background: #F2F2F7; border: none; border-radius: 12px; padding: 14px; width: 100%; outline: none; font-size: 16px; -webkit-appearance: none; }
        .ios-btn { background: var(--apple-blue); color: white; border-radius: 14px; padding: 18px; font-weight: 600; text-align: center; width: 100%; transition: all 0.2s; }
        .ios-btn:active { transform: scale(0.97); }
        
        /* Toggle Paiement */
        .pay-toggle { display: flex; background: #E3E3E8; border-radius: 12px; padding: 4px; cursor: pointer; position: relative; }
        .pay-option { flex: 1; text-align: center; padding: 10px; font-weight: 600; z-index: 1; transition: color 0.3s; color: #8e8e93; }
        .pay-slider { position: absolute; width: calc(50% - 4px); height: calc(100% - 8px); background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .paid .pay-slider { transform: translateX(100%); }
        .paid .opt-paid { color: #34C759; }

        .step-container { display: none; flex-direction: column; animation: fadeIn 0.4s ease; }
        .active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-5 max-w-md mx-auto">

    <header class="mb-6 pt-4">
        <h1 id="step-title" class="text-3xl font-bold tracking-tight">Nouvelle Commande</h1>
        <p id="step-label" class="text-blue-500 font-bold text-xs uppercase mt-1">Étape 1 sur 4</p>
    </header>

    <div id="step-1" class="step-container active">
        <div class="ios-card p-5 space-y-4">
            <input type="text" id="orderNo" class="ios-input font-mono" readonly>
            <input type="text" id="clientName" class="ios-input" placeholder="Nom">
            <input type="tel" id="clientPhone" class="ios-input" placeholder="Téléphone">
        </div>
        <button onclick="nav(2)" class="ios-btn">Suivant</button>
    </div>

    <div id="step-2" class="step-container">
        <div class="ios-card p-5 space-y-4">
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Collection</label>
                <select id="collection" class="ios-input" onchange="updateRefs()">
                    <option>Aucune</option><option>Homme</option><option>Femme</option><option>Enfant</option>
                </select>
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Référence</label>
                <select id="refSelect" class="ios-input"></select>
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Taille</label>
                <select id="size" class="ios-input">
                    <option>S</option><option>M</option><option>L</option><option>XL</option>
                </select>
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Couleur T-shirt</label>
                <select id="tshirtColor" class="ios-input" onchange="updatePreview()"></select>
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Couleur Logo</label>
                <select id="logoColor" class="ios-input"></select>
            </div>
        </div>
        <div class="flex gap-3">
            <button onclick="nav(1)" class="ios-btn bg-gray-200 !text-gray-500">Retour</button>
            <button onclick="nav(3)" class="ios-btn">Design</button>
        </div>
    </div>

    <div id="step-3" class="step-container">
        <div class="flex bg-gray-200 p-1 rounded-xl mb-4">
            <button id="btn-av" onclick="setSide('front')" class="flex-1 py-2 text-sm font-bold rounded-lg bg-white shadow-sm text-blue-600">AVANT</button>
            <button id="btn-ar" onclick="setSide('back')" class="flex-1 py-2 text-sm font-bold rounded-lg text-gray-500">ARRIÈRE</button>
        </div>
        
        <div class="bg-white rounded-[24px] p-2 mb-4 border border-gray-100 flex justify-center overflow-hidden">
            <canvas id="c" width="300" height="340"></canvas>
        </div>

        <div class="ios-card p-4 flex items-center justify-between gap-4">
            <select id="logoSelect" class="ios-input !w-2/3" onchange="applyTextLogo(this.value)">
                <option value="">Logo Catalogue</option>
                <option>AVI-01</option><option>SXM-12</option>
            </select>
            <label class="h-12 w-12 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center cursor-pointer flex-shrink-0">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m-8-8h16"></path></svg>
                <input type="file" class="hidden" accept="image/*" onchange="uploadLogo(event)">
            </label>
        </div>
        <textarea id="note" class="ios-input mb-4" placeholder="Note..."></textarea>

        <div class="flex gap-3">
            <button onclick="nav(2)" class="ios-btn bg-gray-200 !text-gray-500">Retour</button>
            <button onclick="nav(4)" class="ios-btn">Paiement</button>
        </div>
    </div>

    <div id="step-4" class="step-container">
        <div class="ios-card p-6 space-y-6">
            <div class="flex gap-4">
                <div class="flex-1"><label class="text-[10px] font-bold block text-center mb-1 text-gray-400">PRIX</label><input type="number" id="price" class="ios-input text-center font-bold" value="25" oninput="calc()"></div>
                <div class="flex-1"><label class="text-[10px] font-bold block text-center mb-1 text-gray-400">PERSO</label><input type="number" id="customPrice" class="ios-input text-center font-bold" value="0" oninput="calc()"></div>
            </div>
            <div class="text-center">
                <p id="totalLabel" class="text-5xl font-black tracking-tighter">25 €</p>
            </div>
            <div id="payToggle" class="pay-toggle" onclick="togglePaid()">
                <div class="pay-slider"></div>
                <div class="pay-option">NON PAYÉ</div>
                <div class="pay-option opt-paid">PAYÉ ✅</div>
            </div>
        </div>
        <button onclick="submit()" id="submitBtn" class="ios-btn bg-black">Finaliser</button>
    </div>

    <canvas id="recapCanvas" width="600" height="500" class="hidden"></canvas>

    <script>
        const API_URL = "TON_URL_APPS_SCRIPT_ICI"; // <--- REMPLACE MOI !
        const COLORS = [{n:'Blanc',h:'#FFF'},{n:'Noir',h:'#1c1c1e'},{n:'Gris',h:'#8E8E93'},{n:'Rouge',h:'#FF3B30'},{n:'Bleu',h:'#007AFF'}];
        let canvas, side = 'front', paid = false;
        let storage = { front: null, back: null, frontData: null, backData: null };

        window.onload = () => {
            canvas = new fabric.Canvas('c');
            const now = new Date();
            document.getElementById('orderNo').value = `${now.getFullYear()}-${(now.getMonth()+1)}${now.getDate()}-${now.getHours()}${now.getMinutes()}`;
            COLORS.forEach(c => {
                document.getElementById('tshirtColor').add(new Option('● ' + c.n, c.n));
                document.getElementById('logoColor').add(new Option('● ' + c.n, c.n));
            });
            updateRefs(); updatePreview();
        };

        function updateRefs() {
            const c = document.getElementById('collection').value;
            const r = document.getElementById('refSelect');
            r.innerHTML = '';
            if(c === 'Aucune') return;
            const p = c[0]; 
            for(let i=1; i<=10; i++) r.add(new Option(p + i.toString().padStart(3,'0'), p + i.toString().padStart(3,'0')));
        }

        function updatePreview() {
            canvas.clear();
            const hex = COLORS.find(c => c.n === document.getElementById('tshirtColor').value).h;
            const path = side === 'front' ? 
                "M 93,23 L 65,33 L 14,65 L 33,108 L 51,94 L 51,300 L 229,300 L 229,94 L 247,108 L 266,65 L 215,33 L 187,23 C 178,42 150,52 140,52 C 130,52 102,42 93,23 Z" :
                "M 93,23 L 65,33 L 14,65 L 33,108 L 51,94 L 51,300 L 229,300 L 229,94 L 247,108 L 266,65 L 215,33 L 187,23 C 182,28 165,33 140,33 C 115,33 98,28 93,23 Z";
            const tshirt = new fabric.Path(path, { left:150, top:170, fill:hex, stroke:'#ddd', originX:'center', originY:'center', selectable:false });
            canvas.add(tshirt);
            if(storage[side]) canvas.add(storage[side]);
            canvas.renderAll();
        }

        function setSide(s) {
            side = s;
            document.getElementById('btn-av').className = s==='front'?'flex-1 py-2 text-sm font-bold rounded-lg bg-white shadow-sm text-blue-600':'flex-1 py-2 text-sm font-bold rounded-lg text-gray-500';
            document.getElementById('btn-ar').className = s==='back'?'flex-1 py-2 text-sm font-bold rounded-lg bg-white shadow-sm text-blue-600':'flex-1 py-2 text-sm font-bold rounded-lg text-gray-500';
            updatePreview();
        }

        function applyTextLogo(v) {
            if(!v) return;
            const color = COLORS.find(c => c.n === document.getElementById('logoColor').value).h;
            const txt = new fabric.Text(v, { left:150, top:120, fontSize:22, fill:color, originX:'center', fontWeight:'bold' });
            if(storage[side]) canvas.remove(storage[side]);
            storage[side] = txt;
            canvas.add(txt); canvas.setActiveObject(txt);
        }

        function uploadLogo(e) {
            const r = new FileReader();
            r.onload = (f) => {
                fabric.Image.fromURL(f.target.result, (img) => {
                    img.scaleToWidth(80); img.set({ left:150, top:150, originX:'center' });
                    if(storage[side]) canvas.remove(storage[side]);
                    storage[side] = img;
                    canvas.add(img); canvas.setActiveObject(img);
                });
            };
            r.readAsDataURL(e.target.files[0]);
        }

        function togglePaid() { paid = !paid; document.getElementById('payToggle').classList.toggle('paid', paid); }
        function calc() { document.getElementById('totalLabel').innerText = (parseFloat(document.getElementById('price').value)||0) + (parseFloat(document.getElementById('customPrice').value)||0) + " €"; }
        function nav(s) { 
            document.querySelectorAll('.step-container').forEach(e => e.classList.remove('active'));
            document.getElementById('step-'+s).classList.add('active');
            document.getElementById('step-label').innerText = `Étape ${s} sur 4`;
            window.scrollTo(0,0);
        }

        async function submit() {
            const btn = document.getElementById('submitBtn'); btn.innerText = "Génération..."; btn.disabled = true;

            // 1. Capture AVANT
            setSide('front'); await new Promise(r => setTimeout(r, 200));
            const imgAv = canvas.toDataURL();
            
            // 2. Capture ARRIÈRE
            setSide('back'); await new Promise(r => setTimeout(r, 200));
            const imgAr = canvas.toDataURL();

            // 3. Création de la Fiche (Canvas caché)
            const rCanvas = document.getElementById('recapCanvas');
            const ctx = rCanvas.getContext('2d');
            ctx.fillStyle = "white"; ctx.fillRect(0,0,600,500);
            ctx.fillStyle = "black"; ctx.font = "bold 20px Arial";
            ctx.fillText("FICHE COMMANDE : " + document.getElementById('orderNo').value, 20, 40);
            ctx.font = "14px Arial";
            ctx.fillText("Client: " + document.getElementById('clientName').value, 20, 70);
            ctx.fillText("Collection: " + document.getElementById('collection').value + " - " + document.getElementById('refSelect').value, 20, 90);
            
            const loadImg = (src) => new Promise(res => { const i = new Image(); i.onload = () => res(i); i.src = src; });
            const finalAv = await loadImg(imgAv);
            const finalAr = await loadImg(imgAr);
            ctx.drawImage(finalAv, 0, 120, 300, 340);
            ctx.drawImage(finalAr, 300, 120, 300, 340);
            
            const ficheBase64 = rCanvas.toDataURL('image/png');

            const payload = {
                orderNo: document.getElementById('orderNo').value,
                client: document.getElementById('clientName').value,
                phone: document.getElementById('clientPhone').value,
                collection: document.getElementById('collection').value + " / " + document.getElementById('refSelect').value,
                size: document.getElementById('size').value,
                tshirtColor: document.getElementById('tshirtColor').value,
                logoColor: document.getElementById('logoColor').value,
                logoFront: storage.front instanceof fabric.Text ? storage.front.text : "Perso",
                logoBack: storage.back instanceof fabric.Text ? storage.back.text : "Perso",
                note: document.getElementById('note').value,
                price: document.getElementById('price').value,
                customPrice: document.getElementById('customPrice').value,
                total: document.getElementById('totalLabel').innerText,
                paid: paid ? "OUI" : "NON",
                image: ficheBase64
            };

            fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(() => { alert("Terminé !"); location.reload(); })
            .catch(() => { alert("Erreur - Vérifie l'URL API"); btn.disabled = false; });
        }
    </script>
</body>
</html>
