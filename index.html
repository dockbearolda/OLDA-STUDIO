<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Studio T-Shirt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        :root { --apple-blue: #007AFF; --apple-bg: #F5F5F7; }
        body { font-family: -apple-system, sans-serif; background-color: var(--apple-bg); -webkit-font-smoothing: antialiased; }
        .ios-card { background: white; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.04); }
        .ios-input { background: #f2f2f7; border: none; border-radius: 12px; padding: 14px; font-size: 16px; width: 100%; outline: none; }
        .ios-btn { background: var(--apple-blue); color: white; border-radius: 14px; padding: 16px; font-size: 17px; font-weight: 600; text-align: center; width: 100%; cursor: pointer; }
        .ios-btn:active { transform: scale(0.97); }
        .step-container { display: none; flex-direction: column; gap: 15px; animation: slideIn 0.3s ease-out; }
        .step-container.active { display: flex; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        .tab-btn { flex: 1; padding: 10px; border-radius: 10px; font-size: 13px; font-weight: 700; color: #8e8e93; }
        .tab-btn.active { background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: var(--apple-blue); }
    </style>
</head>
<body class="min-h-screen flex flex-col p-5">

    <div class="max-w-md mx-auto w-full mb-6">
        <p id="step-label" class="text-[11px] font-black text-blue-500 uppercase tracking-widest mb-1">Étape 1 sur 4</p>
        <h1 id="step-title" class="text-2xl font-bold text-gray-900">Nouveau Dossier</h1>
    </div>

    <div class="max-w-md mx-auto w-full flex-grow">

        <div id="step-1" class="step-container active">
            <div class="ios-card p-5 space-y-4">
                <input type="text" id="orderNo" class="ios-input" placeholder="N° Commande (Case A)">
                <input type="text" id="clientName" class="ios-input" placeholder="Nom du Client (Case C)">
                <input type="tel" id="clientPhone" class="ios-input" placeholder="Téléphone (Case D)">
            </div>
            <button onclick="nav(2)" class="ios-btn">Suivant</button>
        </div>

        <div id="step-2" class="step-container">
            <div class="ios-card p-5 space-y-4">
                <select id="collection" class="ios-input">
                    <option value="">Collection (Case E)</option>
                    <option>Homme</option><option>Femme</option><option>Enfant</option>
                </select>
                <select id="size" class="ios-input">
                    <option value="">Taille (Case F)</option>
                    <option>S</option><option>M</option><option>L</option><option>XL</option><option>XXL</option>
                </select>
                <select id="tshirtColor" class="ios-input" onchange="updatePreview()">
                    <option value="Blanc">Couleur T-shirt : Blanc</option>
                    <option value="Noir">Couleur T-shirt : Noir</option>
                    <option value="Bleu">Couleur T-shirt : Bleu</option>
                    <option value="Rouge">Couleur T-shirt : Rouge</option>
                </select>
                <input type="text" id="logoColor" class="ios-input" placeholder="Couleur Logo (Case H)">
            </div>
            <div class="flex gap-3">
                <button onclick="nav(1)" class="ios-btn bg-gray-200 !text-gray-500">Retour</button>
                <button onclick="nav(3)" class="ios-btn">Design</button>
            </div>
        </div>

        <div id="step-3" class="step-container">
            <div class="bg-gray-200 p-1 rounded-xl flex mb-4">
                <button id="btn-av" onclick="setSide('front')" class="tab-btn active">AVANT (I)</button>
                <button id="btn-ar" onclick="setSide('back')" class="tab-btn">ARRIÈRE (J)</button>
            </div>
            
            <div class="flex justify-center bg-white rounded-3xl p-4 shadow-inner mb-4">
                <canvas id="c" width="280" height="280"></canvas>
            </div>

            <div class="ios-card p-4 space-y-3">
                <select id="logoSelect" class="ios-input" onchange="applyLogo(this.value)">
                    <option value="">Choisir un Logo...</option>
                    <option>AVI-01</option><option>SXM-12</option><option>BEA-16</option>
                </select>
                <textarea id="note" class="ios-input h-16" placeholder="Notes (Case K)"></textarea>
            </div>

            <div class="flex gap-3">
                <button onclick="nav(2)" class="ios-btn bg-gray-200 !text-gray-500">Retour</button>
                <button onclick="nav(4)" class="ios-btn">Prix</button>
            </div>
        </div>

        <div id="step-4" class="step-container">
            <div class="ios-card p-5 space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 px-1">PRIX UNITAIRE (L)</label>
                        <input type="number" id="price" class="ios-input mt-1" value="20" oninput="updateTotal()">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 px-1">PERSO (M)</label>
                        <input type="number" id="customPrice" class="ios-input mt-1" value="0" oninput="updateTotal()">
                    </div>
                </div>
                <div class="bg-blue-600 p-5 rounded-2xl text-white flex justify-between items-center">
                    <span class="font-bold opacity-80">TOTAL (N)</span>
                    <span id="totalLabel" class="text-3xl font-black">20 €</span>
                </div>
                <select id="paid" class="ios-input">
                    <option value="NON">Statut : Non Payé</option>
                    <option value="OUI">Statut : Payé ✅</option>
                </select>
            </div>
            <button onclick="submit()" id="submitBtn" class="ios-btn bg-black !text-white mt-2">Enregistrer la Commande</button>
            <button onclick="nav(3)" class="text-center text-gray-400 text-sm font-medium w-full py-2">Retour au design</button>
        </div>

    </div>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbxXM44btJkr0IrX6bG1Jw07iku9Uq_boToCpfTEWJSlFaE_QL-YDiBflPsCYWz4E8ck/exec";
        
        let canvas, side = 'front';
        let dataStore = { frontLogo: '', backLogo: '' };
        let objects = { front: [], back: [] };

        window.onload = () => {
            canvas = new fabric.Canvas('c');
            draw();
        };

        function draw() {
            canvas.clear();
            const color = document.getElementById('tshirtColor').value;
            const hex = color === 'Noir' ? '#1c1c1e' : color === 'Bleu' ? '#1e3a8a' : color === 'Rouge' ? '#dc2626' : '#ffffff';
            
            const shape = new fabric.Path("M 80 20 L 120 20 L 140 0 L 210 0 L 230 20 L 270 20 L 280 60 L 250 80 L 240 70 L 240 280 L 110 280 L 110 70 L 100 80 L 70 60 Z", {
                left: 140, top: 140, fill: hex, stroke: '#ddd', strokeWidth: 1, originX: 'center', originY: 'center', selectable: false, scaleX: 1, scaleY: 1
            });
            canvas.add(shape);
            objects[side].forEach(obj => canvas.add(obj));
            canvas.renderAll();
        }

        function setSide(s) {
            objects[side] = canvas.getObjects().filter(o => o.selectable);
            side = s;
            document.getElementById('btn-av').className = s === 'front' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('btn-ar').className = s === 'back' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('logoSelect').value = s === 'front' ? dataStore.frontLogo : dataStore.backLogo;
            draw();
        }

        function applyLogo(val) {
            if(side === 'front') dataStore.frontLogo = val; else dataStore.backLogo = val;
            if(!val) return;
            const txt = new fabric.Text(val, { left: 140, top: 100, fontSize: 20, originX: 'center', fill: '#007AFF', fontWeight: 'bold' });
            canvas.add(txt);
            canvas.setActiveObject(txt);
        }

        function updatePreview() { draw(); }
        function updateTotal() {
            const t = (parseFloat(document.getElementById('price').value)||0) + (parseFloat(document.getElementById('customPrice').value)||0);
            document.getElementById('totalLabel').innerText = t + " €";
        }

        function nav(s) {
            document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
            document.getElementById('step-'+s).classList.add('active');
            document.getElementById('step-label').innerText = `Étape ${s} sur 4`;
            const titles = ["Client", "Configuration", "Design Visuel", "Financement"];
            document.getElementById('step-title').innerText = titles[s-1];
            window.scrollTo(0,0);
        }

        function submit() {
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerText = "⏳ Enregistrement...";
            
            const payload = {
                orderNo: document.getElementById('orderNo').value,
                client: document.getElementById('clientName').value,
                phone: document.getElementById('clientPhone').value,
                collection: document.getElementById('collection').value,
                size: document.getElementById('size').value,
                tshirtColor: document.getElementById('tshirtColor').value,
                logoColor: document.getElementById('logoColor').value,
                logoFront: dataStore.frontLogo,
                logoBack: dataStore.backLogo,
                note: document.getElementById('note').value,
                price: document.getElementById('price').value,
                customPrice: document.getElementById('customPrice').value,
                total: (parseFloat(document.getElementById('price').value)||0) + (parseFloat(document.getElementById('customPrice').value)||0),
                paid: document.getElementById('paid').value,
                image: canvas.toDataURL()
            };

            fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
            .then(() => { alert("✅ Commande enregistrée !"); location.reload(); })
            .catch(() => { alert("❌ Erreur réseau"); btn.disabled = false; });
        }
    </script>
</body>
</html>
