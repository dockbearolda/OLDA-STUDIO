<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T-Shirt Designer Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        :root { --apple-blue: #007AFF; --apple-bg: #F5F5F7; }
        body { font-family: -apple-system, sans-serif; background-color: var(--apple-bg); color: #1d1d1f; -webkit-font-smoothing: antialiased; }
        .ios-card { background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .ios-input { background: #f2f2f7; border: none; border-radius: 12px; padding: 16px; font-size: 17px; width: 100%; outline: none; }
        .ios-btn { background: var(--apple-blue); color: white; border-radius: 14px; padding: 18px; font-size: 17px; font-weight: 600; width: 100%; transition: all 0.2s; }
        .ios-btn:active { transform: scale(0.97); opacity: 0.9; }
        .step-container { display: none; flex-direction: column; gap: 20px; animation: fadeIn 0.4s ease forwards; }
        .step-container.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .canvas-container { margin: 0 auto !important; border-radius: 20px; overflow: hidden; background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .tab-btn { padding: 10px 20px; border-radius: 10px; font-weight: 600; font-size: 14px; }
        .tab-btn.active { background: var(--apple-blue); color: white; }
    </style>
</head>
<body class="min-h-screen w-full flex flex-col p-4">

    <div class="max-w-md mx-auto w-full pt-4 pb-8 text-center">
        <h1 class="text-xl font-bold tracking-tight">Studio Création</h1>
        <div class="h-1.5 w-full bg-gray-200 mt-4 rounded-full overflow-hidden">
            <div id="progress-bar" class="h-full bg-blue-500 w-0 transition-all duration-500"></div>
        </div>
    </div>

    <div class="max-w-md mx-auto w-full flex-grow">

        <div id="step-1" class="step-container active">
            <h2 class="text-3xl font-bold">Client</h2>
            <div class="space-y-4">
                <input type="text" id="input-client" class="ios-input" placeholder="Nom du client">
                <input type="tel" id="input-phone" class="ios-input" placeholder="Numéro de téléphone">
                <button onclick="nextStep(2)" class="ios-btn mt-4">Continuer</button>
            </div>
        </div>

        <div id="step-2" class="step-container">
            <h2 class="text-2xl font-bold">Détails</h2>
            <div class="space-y-4">
                <select id="input-collection" class="ios-input" onchange="updateRefs()">
                    <option value="">Choisir la collection</option>
                    <option value="H">Homme</option>
                    <option value="F">Femme</option>
                    <option value="E">Enfant</option>
                </select>
                <select id="input-ref" class="ios-input">
                    <option value="">Choisir la référence</option>
                </select>
                <div>
                    <label class="text-xs font-bold text-gray-500 ml-2">Échéance commande</label>
                    <input type="date" id="input-deadline" class="ios-input mt-1">
                </div>
                <div class="flex gap-3">
                    <button onclick="prevStep(1)" class="ios-btn bg-gray-200 !text-gray-700">Retour</button>
                    <button onclick="nextStep(3)" class="ios-btn">Suivant</button>
                </div>
            </div>
        </div>

        <div id="step-3" class="step-container">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">Design</h2>
                <div class="flex gap-1 bg-gray-200 p-1 rounded-xl">
                    <button id="tab-front" onclick="switchSide('front')" class="tab-btn active">Avant</button>
                    <button id="tab-back" onclick="switchSide('back')" class="tab-btn">Arrière</button>
                </div>
            </div>

            <canvas id="main-canvas" width="350" height="350"></canvas>

            <div class="ios-card p-4 space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase">Couleur T-Shirt</label>
                    <div class="flex gap-3 mt-2">
                        <button onclick="changeTshirtColor('#ffffff', 'Blanc')" class="w-8 h-8 rounded-full bg-white border border-gray-300"></button>
                        <button onclick="changeTshirtColor('#1c1c1e', 'Noir')" class="w-8 h-8 rounded-full bg-black"></button>
                        <button onclick="changeTshirtColor('#1e3a8a', 'Bleu')" class="w-8 h-8 rounded-full bg-blue-900"></button>
                        <button onclick="changeTshirtColor('#dc2626', 'Rouge')" class="w-8 h-8 rounded-full bg-red-600"></button>
                        <button onclick="changeTshirtColor('#166534', 'Vert')" class="w-8 h-8 rounded-full bg-green-800"></button>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase">Ajouter un Logo</label>
                    <select id="select-logo" class="ios-input mt-2" onchange="addLogoToCanvas(this.value)">
                        <option value="">Sélectionner un logo...</option>
                        <option value="AVI-01">AVI-01</option>
                        <option value="SXM-12">SXM-12</option>
                        <option value="BEA-16">BEA-16</option>
                    </select>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="prevStep(2)" class="ios-btn bg-gray-200 !text-gray-700">Retour</button>
                <button onclick="nextStep(4)" class="ios-btn">Terminer</button>
            </div>
        </div>

        <div id="step-4" class="step-container">
            <h2 class="text-2xl font-bold text-center">Récapitulatif</h2>
            <div id="final-preview" class="ios-card p-4 space-y-2 text-sm"></div>
            <button onclick="submitOrder()" id="btn-submit" class="ios-btn bg-green-600">Confirmer l'envoi</button>
            <button onclick="prevStep(3)" class="text-blue-500 font-semibold text-center w-full mt-2">Modifier</button>
        </div>

        <div id="step-5" class="step-container text-center pt-10">
            <h2 class="text-3xl font-bold">Envoyé ! ✅</h2>
            <button onclick="location.reload()" class="ios-btn mt-8 bg-black">Nouvelle Commande</button>
        </div>

    </div>

    <script>
        const GOOGLE_URL = 'https://script.google.com/macros/s/AKfycbxXM44btJkr0IrX6bG1Jw07iku9Uq_boToCpfTEWJSlFaE_QL-YDiBflPsCYWz4E8ck/exec';
        
        let canvas;
        let currentSide = 'front';
        let tshirtColor = '#ffffff';
        let colorName = 'Blanc';
        let designs = { front: { objects: [] }, back: { objects: [] } };
        let orderData = {};

        const tshirtPath = "M 80 20 L 120 20 L 140 0 L 210 0 L 230 20 L 270 20 L 280 60 L 250 80 L 240 70 L 240 280 L 110 280 L 110 70 L 100 80 L 70 60 Z";

        window.onload = function() {
            canvas = new fabric.Canvas('main-canvas', { backgroundColor: '#ffffff' });
            renderTshirt();
            updateProgressBar(1);
        };

        function renderTshirt() {
            canvas.clear();
            const shape = new fabric.Path(tshirtPath, {
                left: 175, top: 175, fill: tshirtColor, stroke: '#d1d1d6', strokeWidth: 2,
                selectable: false, evented: false, originX: 'center', originY: 'center', scaleX: 1.2, scaleY: 1.2
            });
            canvas.add(shape);
            designs[currentSide].objects.forEach(obj => canvas.add(obj));
            canvas.renderAll();
        }

        function changeTshirtColor(hex, name) {
            tshirtColor = hex;
            colorName = name;
            renderTshirt();
        }

        function switchSide(side) {
            designs[currentSide].objects = canvas.getObjects().filter(obj => obj.selectable);
            currentSide = side;
            document.getElementById('tab-front').classList.toggle('active', side === 'front');
            document.getElementById('tab-back').classList.toggle('active', side === 'back');
            renderTshirt();
        }

        function addLogoToCanvas(logoName) {
            if (!logoName) return;
            const text = new fabric.Text(logoName, {
                left: 175, top: 120, fontSize: 25, fontFamily: 'Helvetica', fontWeight: 'bold',
                fill: (tshirtColor === '#1c1c1e' || tshirtColor === '#1e3a8a' ? 'white' : 'black'),
                originX: 'center', cornerColor: '#007AFF', transparentCorners: false
            });
            canvas.add(text);
            canvas.setActiveObject(text);
            document.getElementById('select-logo').value = "";
        }

        function updateRefs() {
            const col = document.getElementById('input-collection').value;
            const refSelect = document.getElementById('input-ref');
            refSelect.innerHTML = '<option value="">Choisir la référence</option>';
            if(!col) return;
            for(let i=1; i<=10; i++) {
                let val = col + String(i).padStart(3, '0');
                refSelect.innerHTML += `<option value="${val}">${val}</option>`;
            }
        }

        function nextStep(s) {
            if(s === 2) {
                orderData.client = document.getElementById('input-client').value;
                orderData.phone = document.getElementById('input-phone').value;
                if(!orderData.client || !orderData.phone) return alert("Nom et Téléphone requis");
            }
            if(s === 3) {
                orderData.collection = document.getElementById('input-collection').value;
                orderData.reference = document.getElementById('input-ref').value;
                orderData.deadline = document.getElementById('input-deadline').value;
                if(!orderData.collection || !orderData.reference) return alert("Collection et Référence requises");
            }
            if(s === 4) {
                switchSide('front'); 
                orderData.image = canvas.toDataURL({ format: 'png', multiplier: 1 });
                orderData.colorName = colorName;
                orderData.logoFront = designs.front.objects.map(o => o.text).join(', ') || 'Aucun';
                orderData.logoBack = designs.back.objects.map(o => o.text).join(', ') || 'Aucun';

                document.getElementById('final-preview').innerHTML = `
                    <p><b>Client:</b> ${orderData.client}</p>
                    <p><b>Tel:</b> ${orderData.phone}</p>
                    <p><b>Ref:</b> ${orderData.reference} (${orderData.collection})</p>
                    <p><b>Couleur:</b> ${colorName}</p>
                    <p><b>Logo AV:</b> ${orderData.logoFront}</p>
                    <p><b>Logo AR:</b> ${orderData.logoBack}</p>
                `;
            }
            document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
            document.getElementById('step-'+s).classList.add('active');
            updateProgressBar(s);
            window.scrollTo(0,0);
        }

        function prevStep(s) {
            document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
            document.getElementById('step-'+s).classList.add('active');
            updateProgressBar(s);
        }

        function updateProgressBar(s) {
            document.getElementById('progress-bar').style.width = (s / 5 * 100) + '%';
        }

        function submitOrder() {
            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            btn.innerText = "Envoi...";
            fetch(GOOGLE_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(orderData) })
            .then(() => nextStep(5))
            .catch(() => { alert("Erreur"); btn.disabled = false; });
        }
    </script>
</body>
</html>
